<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connect WhatsApp - CabMind</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Connect your WhatsApp Business to CabMind AI-powered taxi booking system" />
  <link rel="icon" type="image/png" href="./V1_logo_with_bg.png" />
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a365d 0%, #0f172a 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      max-width: 520px;
      width: 100%;
      overflow: hidden;
    }
    
    .header {
      background: #ffffff;
      padding: 30px 30px 20px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .logo {
      max-width: 280px;
      height: auto;
      margin-bottom: 10px;
    }
    
    .tagline {
      font-size: 14px;
      color: #1a5276;
      font-weight: 500;
    }
    
    .content {
      padding: 35px;
    }
    
    h2 {
      color: #1a365d;
      font-size: 24px;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .description {
      color: #64748b;
      font-size: 15px;
      line-height: 1.7;
      text-align: center;
      margin-bottom: 28px;
    }
    
    .features {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 28px;
      border: 1px solid #e2e8f0;
    }
    
    .features ul {
      list-style: none;
    }
    
    .features li {
      padding: 12px 0;
      color: #334155;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .features li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .features li:first-child {
      padding-top: 0;
    }
    
    .check-icon {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      font-weight: bold;
    }
    
    .connect-btn {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
      border: none;
      padding: 18px 32px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 14px;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }
    
    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(37, 211, 102, 0.4);
    }
    
    .connect-btn:active {
      transform: translateY(0);
    }
    
    .connect-btn:disabled {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .connect-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .footer-note {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
      color: #94a3b8;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .footer-note a {
      color: #1a5276;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer-note a:hover {
      text-decoration: underline;
    }
    
    /* Status Messages */
    .status {
      margin-top: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      display: none;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .status.show { display: block; }
    .status.info { background: #e0f2fe; color: #0369a1; border: 1px solid #7dd3fc; }
    .status.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .status.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .status.warning { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
    
    /* Success State */
    .success-panel {
      display: none;
      text-align: center;
      padding: 20px 0;
    }
    
    .success-panel.show { display: block; }
    
    .success-icon {
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 45px;
      border: 3px solid #86efac;
    }
    
    .success-panel h3 {
      color: #166534;
      font-size: 22px;
      margin-bottom: 10px;
    }
    
    .success-panel .description {
      margin-bottom: 20px;
    }
    
    .success-details {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
      font-size: 13px;
      border: 1px solid #e2e8f0;
    }
    
    .success-details p {
      margin: 10px 0;
      color: #475569;
      display: flex;
      justify-content: space-between;
    }
    
    .success-details strong {
      color: #1e293b;
    }
    
    .success-details .value {
      font-family: 'SF Mono', Monaco, monospace;
      color: #1a5276;
      font-size: 12px;
    }
    
    .dashboard-btn {
      background: linear-gradient(135deg, #1a5276 0%, #1a365d 100%);
      color: white;
      border: none;
      padding: 16px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dashboard-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 82, 118, 0.3);
    }
    
    /* Powered by badge */
    .powered-by {
      text-align: center;
      padding: 15px;
      background: #f8fafc;
      color: #94a3b8;
      font-size: 12px;
    }
    
    .powered-by a {
      color: #1a5276;
      text-decoration: none;
      font-weight: 600;
    }
    
    /* Debug Panel (remove in production) */
    .debug-panel {
      margin-top: 20px;
      background: #0f172a;
      border-radius: 12px;
      padding: 16px;
      display: none;
    }
    
    .debug-panel.show { display: block; }
    
    .debug-panel h4 {
      color: #25D366;
      font-size: 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .debug-panel pre {
      color: #cbd5e1;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, monospace;
    }
  </style>
</head>

<body>

<div class="container">
  <div class="header">
    <!-- CabMind Logo -->
    <img src="https://cabmind.co.uk/logo.png" alt="CabMind" class="logo" 
         onerror="this.style.display='none'; document.getElementById('fallbackLogo').style.display='block';">
    <div id="fallbackLogo" style="display:none; font-size: 32px; font-weight: 700; color: #1a5276;">
      üöï CABMIND
    </div>
    <div class="tagline">AI-Powered Communication for Taxi Operators</div>
  </div>
  
  <div class="content">
    <!-- Initial State -->
    <div id="initialState">
      <h2>Connect Your WhatsApp</h2>
      
      <p class="description">
        Link your WhatsApp Business number to enable automated bookings, 
        real-time updates, and 24/7 AI-powered customer support.
      </p>
      
      <div class="features">
        <ul>
          <li>
            <span class="check-icon">‚úì</span>
            <span>Keep using your WhatsApp Business App normally</span>
          </li>
          <li>
            <span class="check-icon">‚úì</span>
            <span>Automated booking confirmations & updates</span>
          </li>
          <li>
            <span class="check-icon">‚úì</span>
            <span>AI handles customer inquiries 24/7</span>
          </li>
          <li>
            <span class="check-icon">‚úì</span>
            <span>All messages sync between app & system</span>
          </li>
          <li>
            <span class="check-icon">‚úì</span>
            <span>Set up in under 5 minutes</span>
          </li>
        </ul>
      </div>
      
      <button class="connect-btn" id="connectBtn" onclick="launchWhatsAppSignup()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
        Connect WhatsApp Business
      </button>
      
      <p class="footer-note">
        üîí Secure connection via Meta's official API<br>
        <a href="https://cabmind.co.uk/privacy" target="_blank">Privacy Policy</a> ¬∑ 
        <a href="https://cabmind.co.uk/terms" target="_blank">Terms of Service</a>
      </p>
    </div>
    
    <!-- Success State -->
    <div id="successState" class="success-panel">
      <div class="success-icon">‚úì</div>
      <h3>WhatsApp Connected!</h3>
      <p class="description">Your WhatsApp Business number is now linked to CabMind. You're all set!</p>
      
      <div class="success-details" id="connectionDetails">
        <!-- Populated by JavaScript -->
      </div>
      
      <button class="dashboard-btn" onclick="window.location.href='https://cabmind.co.uk/dashboard'">
        Continue to Dashboard ‚Üí
      </button>
    </div>
    
    <!-- Status Messages -->
    <div id="statusMessage" class="status"></div>
    
    <!-- Debug Panel (remove in production by setting CONFIG.debug = false) -->
    <div id="debugPanel" class="debug-panel">
      <h4>üîß Debug Mode</h4>
      <pre id="debugOutput">Waiting for action...</pre>
    </div>
  </div>
  
  <div class="powered-by">
    Powered by <a href="https://cabmind.co.uk" target="_blank">CabMind</a> ¬∑ AI for Taxi Operators
  </div>
</div>

<!-- Facebook SDK -->
<script>
  // ============================================
  // CONFIGURATION
  // ============================================
  const CONFIG = {
    // Your Meta App ID
    appId: '1302145801707701',
    
    // Solution ID - You'll get this after Tech Provider approval
    // Until then, use your App ID (works for testing your own account)
    solutionId: '1302145801707701',
    
    // API Version
    apiVersion: 'v21.0',
    
    // Your backend webhook to receive signup data
    signupWebhook: 'https://automation.cabmind.co.uk/webhook/client-signup',
    
    // Debug mode - SET TO FALSE IN PRODUCTION
    debug: true
  };

  // ============================================
  // FACEBOOK SDK INITIALIZATION
  // ============================================
  window.fbAsyncInit = function() {
    FB.init({
      appId: CONFIG.appId,
      autoLogAppEvents: true,
      xfbml: false,
      version: CONFIG.apiVersion
    });
    
    log('‚úÖ Facebook SDK initialized');
  };

  // Load SDK
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  // ============================================
  // MESSAGE EVENT LISTENER
  // Captures WhatsApp signup completion data from Meta
  // ============================================
  window.addEventListener('message', function(event) {
    if (!event.origin.includes('facebook.com')) return;
    
    try {
      const data = JSON.parse(event.data);
      log('üì® Message from Meta:\n' + JSON.stringify(data, null, 2));
      
      // WhatsApp Embedded Signup completion
      if (data.type === 'WA_EMBEDDED_SIGNUP') {
        handleSignupComplete(data);
      }
      
      // Alternative format
      if (data.data && data.data.phone_number_id) {
        handleSignupComplete({ data: data.data });
      }
      
    } catch (e) {
      // Not JSON, ignore
    }
  });

  // ============================================
  // LAUNCH WHATSAPP EMBEDDED SIGNUP
  // ============================================
  function launchWhatsAppSignup() {
    const btn = document.getElementById('connectBtn');
    btn.disabled = true;
    btn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 6v6l4 2"></path>
      </svg>
      Connecting...
    `;
    
    showStatus('Opening WhatsApp Business setup...', 'info');
    log('üöÄ Starting Embedded Signup flow...');

    FB.login(function(response) {
      log('üîê FB.login response:\n' + JSON.stringify(response, null, 2));

      if (response.authResponse) {
        showStatus('Facebook connected! Complete the WhatsApp setup in the popup window...', 'info');
        
        // Check if WhatsApp data came directly in response
        if (response.authResponse.phoneNumberId) {
          handleSignupComplete({
            data: {
              phone_number_id: response.authResponse.phoneNumberId,
              waba_id: response.authResponse.wabaId,
              business_id: response.authResponse.businessId
            }
          });
        }
        // Otherwise, wait for message event listener to capture it
        
      } else {
        log('‚ùå User cancelled or error');
        showStatus('Connection cancelled. Please try again when ready.', 'error');
        resetButton();
      }
    }, {
      scope: 'business_management,whatsapp_business_management,whatsapp_business_messaging',
      extras: {
        feature: 'whatsapp_embedded_signup',
        setup: {
          solutionID: CONFIG.solutionId
        },
        sessionInfoVersion: 2
      }
    });
  }

  // ============================================
  // HANDLE SIGNUP COMPLETION
  // ============================================
  async function handleSignupComplete(eventData) {
    log('üéâ Processing signup:\n' + JSON.stringify(eventData, null, 2));
    
    const signupData = {
      phone_number_id: eventData.data?.phone_number_id || null,
      waba_id: eventData.data?.waba_id || null,
      business_id: eventData.data?.business_id || null,
      display_phone_number: eventData.data?.display_phone_number || null,
      timestamp: new Date().toISOString(),
      raw_data: eventData.data || eventData
    };
    
    if (!signupData.phone_number_id) {
      showStatus('Setup completed but missing data. Please contact support@cabmind.co.uk', 'warning');
      log('‚ö†Ô∏è No phone_number_id received');
      resetButton();
      return;
    }
    
    showStatus('Saving your connection...', 'info');
    
    try {
      const response = await fetch(CONFIG.signupWebhook, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(signupData)
      });
      
      if (response.ok) {
        const result = await response.json();
        log('‚úÖ Backend saved:\n' + JSON.stringify(result, null, 2));
        showSuccessState(signupData, result);
      } else {
        throw new Error('Server error: ' + response.status);
      }
      
    } catch (error) {
      log('‚ö†Ô∏è Backend error: ' + error.message);
      // Still show success since WhatsApp connection worked
      showSuccessState(signupData, null);
      showStatus('Connected! (Note: Please contact support to complete setup)', 'warning');
    }
  }

  // ============================================
  // UI HELPERS
  // ============================================
  function showSuccessState(signupData, serverResponse) {
    document.getElementById('initialState').style.display = 'none';
    
    const successState = document.getElementById('successState');
    successState.classList.add('show');
    
    const details = document.getElementById('connectionDetails');
    details.innerHTML = `
      <p><strong>Phone Number ID</strong> <span class="value">${signupData.phone_number_id}</span></p>
      <p><strong>WABA ID</strong> <span class="value">${signupData.waba_id || 'Pending'}</span></p>
      ${serverResponse?.client_id ? `<p><strong>Client ID</strong> <span class="value">${serverResponse.client_id}</span></p>` : ''}
      <p><strong>Status</strong> <span class="value" style="color: #166534;">‚úì Connected</span></p>
    `;
  }
  
  function showStatus(message, type) {
    const el = document.getElementById('statusMessage');
    el.innerHTML = message;
    el.className = 'status show ' + type;
  }
  
  function resetButton() {
    const btn = document.getElementById('connectBtn');
    btn.disabled = false;
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px;height:24px">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
      </svg>
      Connect WhatsApp Business
    `;
  }
  
  function log(message) {
    console.log('[CabMind]', message);
    if (CONFIG.debug) {
      const panel = document.getElementById('debugPanel');
      const output = document.getElementById('debugOutput');
      panel.classList.add('show');
      output.textContent = message;
    }
  }
</script>

</body>
</html>
